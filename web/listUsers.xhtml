<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/template/template.xhtml"
                xmlns:a="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:f="http://xmlns.jcp.org/jsf/core">

    <ui:define name="text">
        <div class="row">
            <div class="container-fluid">
                <h1 class="center">BUSCA COMIDA TÍPICA POR ZONAS O NAVEGANDO</h1>
            </div>
        </div>
        <div class="row">
            <div class="col s12">
                <div class="center card-panel teal">
                    <span class="white-text">Busca en tus cercanías o moviéndote por el mapa.<br></br>
                        Los puntos <FONT COLOR="yellow">amarillos</FONT> son restaurantes.<br></br>
                        Los puntos <FONT COLOR="blue">azules</FONT> son particulares.<br></br>
                        Los puntos <FONT COLOR="red">rojos</FONT> son las ubicaciones buscadas.<br></br>
                        Cada usuario será responsable de concretar con una empresa de transporte para la entrega.<br></br>
                        El precio de los portes será acordado entre los usuarios.<br></br>
                        Se puede contactar libremente por teléfono, email o sin salir de la aplicación mediante mensaje privado.<br></br>
                        Los productos deberán ser empaquetados en envases adecuados para la conservación óptima del producto y entregarse en buen estado.<br></br>
                        El incumplimiento de las normas supondrá la eliminación instantanea del usuario en la aplicación.<br></br>

                    </span>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <h:form id="listUsers"> 
                <h:dataTable   var="User" value="#{userCtrl.users}" styleClass="table table-bordered centered" border="2"  >
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Nombre"></h:outputText>
                        </f:facet>
                        <h:outputText value="#{User.name}"  ></h:outputText>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Email "></h:outputText>
                        </f:facet>
                        <h:outputText value="#{User.email}"  ></h:outputText>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Teléfono "></h:outputText>
                        </f:facet>
                        <h:outputText value="#{User.phone}"  ></h:outputText>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Dirección "></h:outputText>
                        </f:facet>
                        <h:outputText value="#{User.address}" ></h:outputText>
                    </h:column>

                    <h:column >
                        <f:facet name="header">
                            <h:outputText value="Rating "></h:outputText>
                        </f:facet>
                        <p:rating value="#{productCtrl.getAverageRatingProductsUser(User.id)}" readonly="true" styleClass="center-rating estrellas"/>
                    </h:column>
                    <h:column>
                        <f:facet name="header">
                            <h:outputText value="Contactar"></h:outputText>
                        </f:facet>
                        <h:form id="addPrM">

                            <h:commandButton image="resources/images/mail.png" actionListener="#{privateMessageCtrl.dataPM}" style="width:30%;height:30%;"  onclick="PF('pm').show();" >

                                <f:ajax render=":formM:sendM" execute="@form" />
                                <f:attribute name="nameUser" value="#{User.name}" />  
                            </h:commandButton>
                        </h:form>
                    </h:column>

                </h:dataTable> 
            </h:form>
            <h:form id="formM">
                <p:dialog header="Mensaje Privado" widgetVar="pm" minHeight="100">
                    <h:panelGroup id="sendM">
                        <h:inputText readonly="true" id="dest" value="Para #{privateMessageCtrl.destination}" />
                        <p:inputTextarea value="#{privateMessageCtrl.pmsg.message}"  rows="5" cols="30" counter="display" maxlength="120" counterTemplate="{0} caracteres restantes." autoResize="true" />
                        <h:outputText id="display" />
                        <br/>
                        <br/>
                        <h:commandButton  actionListener ="#{privateMessageCtrl.sendPrivateMessage}" styleClass="btn btn-skin btn-scroll"  value="Enviar"  onclick="PF('pm').hide(); Materialize.toast('Mensaje enviado!', 4000, '', function () {})">
                            <f:ajax  execute="@form" />
                            <f:attribute name="emisor" value="#{request.remoteUser}" /> 
                            <f:attribute name="destinatario" value="#{privateMessageCtrl.destination}" />  
                        </h:commandButton>
                    </h:panelGroup>
                </p:dialog>
            </h:form>
        </div>
    </ui:define>
    <ui:define name="map">
        <script type="text/javascript">
            function geocode() {
                PF('gmap').geocode(document.getElementById('address1').value);
            }
        </script>

        <div class="row">
            <div class="col s12 m6">
                <h:form  prependId="false">  
                    <h:panelGrid columns="3"  cellpadding="5">
                        <p:outputLabel for="address1" value="Ciudad o pueblo:" />
                        <p:inputText id="address1" styleClass="address1" />
                        <p:commandButton value="Busca en el mapa" icon="ui-icon-search" onclick="geocode()" />
                    </h:panelGrid>
                    <!--<div class="iframe-rwd">-->


                    <p:gmap id="gmap" widgetVar="gmap" center="#{mapCtrl.centerGeoMap}" zoom="8" type="ROADMAP" model="#{mapCtrl.advancedModel}" style="width:600px;height:400px">
                        <p:ajax event="geocode" listener="#{mapCtrl.onGeocode}" update="@this" />
                        <p:ajax event="overlaySelect" listener="#{mapCtrl.onMarkerSelect}" />

                        <p:gmapInfoWindow id="infoWindow">

                            <p:outputPanel style="text-align: center;">



                                <div class="row">
                                    <h:outputText style="font-size: larger" value="#{mapCtrl.marker.shadow}" />
                                </div>
                                <div class="row">
                                    <!--value="#{productCtrl.getAverageRatingProductsUser(userCtrl.daoUser.getUserByName(mapCtrl.marker.title).id)}"-->
                                    <p:rating value="5"  styleClass="center-rating estrellas"></p:rating>
                                </div>
                                <p:commandButton styleClass="btn-large" value="Ver que ofrece" action="#{userCtrl.enabletable}" update="panel" onclick="Materialize.toast('Esto es lo que ofrece', 4000, '', function () {

                                        })">
                                </p:commandButton>
                            </p:outputPanel>
                        </p:gmapInfoWindow>
                    </p:gmap>

                </h:form>
            </div>

            <div class="col s12 m6">
                <h:form prependId="false">
                    <p:outputPanel id="panel" >

                        <br/>
                        <br/>
                        <br/>

                        <p:dataTable reflow="true" var="p"  value="#{productCtrl.getProductsUser(userCtrl.getUserByName(mapCtrl.marker.title).id)}" styleClass="table table-bordered centered"  rendered="#{userCtrl.showtable}"  >
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Foto"></h:outputText>
                                </f:facet>
                                <div class="card-image waves-effect waves-block waves-light">
                                    <img class="activator" src="resources/images/#{p.imagen}" width="100%" height="100%"></img>
                                </div>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Nombre"></h:outputText>
                                </f:facet>
                                <h:outputText value="#{p.name}" ></h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Descripción"></h:outputText>
                                </f:facet>
                                <h:outputText value="#{p.descripcion}" ></h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Precio "></h:outputText>
                                </f:facet>
                                <h:outputText value="#{p.precio} Euros" ></h:outputText>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Rating "></h:outputText>
                                </f:facet>
                                <p:rating value="#{p.ratingAverage}" readonly="true" styleClass="center-rating estrellas"></p:rating>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Añadir carrito "></h:outputText>
                                </f:facet>

                                <h:form id="addP"> 
                                    <h:commandButton image="resources/images/add1.svg" style="width:70%;height:70%;align:centered;" actionListener ="#{orderCtrl.addProduct}"   onclick="Materialize.toast('Producto añadido al carrito!', 4000, '', function () {})">

                                        <f:ajax render=":pr:cartshopping" execute="@form" />
                                        <f:attribute name="idProduct" value="#{p.id}" />  
                                        <f:attribute name="nameSaler" value="#{p.u.name}"/>
                                    </h:commandButton>
                                </h:form>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="Comentarios"></h:outputText>
                                </f:facet>
                                <h:form id="addPrM">
                                    <h:commandButton  image="resources/images/comment.png"  actionListener="#{commentCtrl.listenerComment}"  style="width:70%;height:70%;" onclick="PF('comments').show();">
                                        <f:ajax render=":formC:co" execute="@form" />
                                        <f:attribute name="idProduct" value="#{p.id}"/>
                                    </h:commandButton>
                                </h:form>
                            </p:column>
                        </p:dataTable>
                    </p:outputPanel>
                </h:form>
                <h:form id="formC">
                    <p:dialog header="Comentarios" widgetVar="comments" minHeight="100">
                        <h:panelGroup id="co">
                            <h:outputLabel style="color:green;" value="Este producto no tiene comentarios" rendered="#{empty commentCtrl.getCommentsProduct(commentCtrl.idP)}" />
                            <ui:repeat value="#{commentCtrl.getCommentsProduct(commentCtrl.idP)}" var="c" class="col s12 m6">
                                <div class="card center">
                                    <div class="row">
                                        <h:outputText value="#{c.comment}" ></h:outputText>
                                    </div>
                                    <br/>
                                    <div class="row">
                                        <h:outputText style="color:green;" value="Escrito por: #{c.u.name}" ></h:outputText>
                                    </div>
                                    <div class="row">
                                        
                                        <h:outputText value=" #{c.date}" >
                                            <f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
                                        </h:outputText>
                                    </div>
                                </div>
                                <br/>
                                <br/>
                                <br/>
                                <br/>
                            </ui:repeat>
                        </h:panelGroup>
                    </p:dialog>
                </h:form>
            </div>
        </div>
    </ui:define>
</ui:composition>